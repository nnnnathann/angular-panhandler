/*! angular-panhandler - v1.0.0 - 2014-12-10
* Copyright (c) 2014 ; Licensed MIT %> */
/*! angular-panhandler - v1.0.0 - 2014-12-10
* Copyright (c) 2014 ; Licensed MIT %> */
!function(){"use strict";function getWidth($el){return $el[0].scrollWidth}function getHeight($el){return $el[0].scrollHeight}function getOffsetWidth($el){return"function"==typeof $el.width?$el.offsetParent().width():$el[0].offsetWidth}function getOffsetHeight($el){return"function"==typeof $el.height?$el.offsetParent().height():$el[0].offsetHeight}function has3d(){var doeshave,el=document.createElement("p"),transforms={webkitTransform:"-webkit-transform",OTransform:"-o-transform",msTransform:"-ms-transform",MozTransform:"-moz-transform",transform:"transform"};document.body.insertBefore(el,null);for(var t in transforms)void 0!==el.style[t]&&(el.style[t]="translate3d(1px,1px,1px)",doeshave=window.getComputedStyle(el).getPropertyValue(transforms[t]));return document.body.removeChild(el),void 0!==doeshave&&doeshave.length>0&&"none"!==doeshave}angular.module("panhandler",[]).directive("panhandler",function PanhandlerFactory($document){function Panhandler($el,attr,$scope){this.$el=$el,this.contentWidth=attr.contentWidth,this.contentHeight=attr.contentHeight,this.curr=[],this.origin=[],this.startPos=[],this.pos=[0,0],this.touch="ontouchstart"in window||window.DocumentTouch&&document instanceof DocumentTouch,this.has3d=has3d(),this.overEvent="mouseover",this.downEvent=this.touch?"touchstart":"mousedown",this.upEvent=this.touch?"touchend":"mouseup",this.moveEvent=this.touch?"touchmove":"mousemove",this.noTouch=vendorize("user-select","none"),this.$scope=$scope,this.startBind=angular.bind(this,this.startDrag),this.endBind=angular.bind(this,this.endDrag),this.updateBind=angular.bind(this,this.updateDrag),this.mouseOutBind=angular.bind(this,this.mouseOut),this.mouseOverBind=angular.bind(this,this.mouseOver),this.init()}return PanhandlerFactory.$inject=["$document"],Panhandler.prototype={init:function(){this.$el.css("overflow","hidden"),this.draggable=angular.element('<div class="panhandler-wrap"></div>'),this.draggable.css(this.noTouch),this.contentWidth&&this.draggable.css("width",this.contentWidth),this.grabCursor(),angular.forEach(this.$el.contents(),angular.bind(this,function(c){this.draggable.append(c)})),this.draggable.append('<div style="clear:both;"></div>'),this.$el.append(this.draggable),this.makeInteractive()},tick:function(){this.origin.length&&this.dirty&&(this.updatePosition(),this.dirty=!1),this.loop=window.requestAnimationFrame(angular.bind(this,this.tick))},updatePosition:function(){var x=this.clampX(this.startPos[0]+(this.curr[0]-this.origin[0])),y=this.clampY(this.startPos[1]+(this.curr[1]-this.origin[1]));if(this.pos=[x,y],this.has3d){var trans=vendorize("transform","translate3d("+x+"px,"+y+"px, 0)");this.draggable.css(trans)}else this.draggable.css("margin-left",x+"px"),this.draggable.css("margin-top",y+"px")},clampX:function(val){return Math.max(Math.min(0,val),this.minX)},clampY:function(val){return Math.max(Math.min(0,val),this.minY)},cacheBounds:function(){this.contentDimensions=[getWidth(this.draggable),getHeight(this.draggable)],this.viewDimensions=[getOffsetWidth(this.$el),getOffsetHeight(this.$el)],this.minX=Math.min(this.viewDimensions[0]-this.contentDimensions[0],0),this.minY=Math.min(this.viewDimensions[1]-this.contentDimensions[1],0)},isPrevented:function(){return this.$scope.preventPan===!0||"true"===this.$scope.preventPan},startDrag:function(e){return this.isPrevented()?!1:(this.origin=this.positionFromEvent(e),this.startPos=[this.pos[0],this.pos[1]],this.cacheBounds(),this.grabbingCursor(),$document.on(this.moveEvent,this.updateBind),$document.on(this.upEvent,this.endBind),this.$el.on("mouseout",this.mouseOutBind),this.updateDrag(e),void this.tick())},updateDrag:function(e){var curr=this.positionFromEvent(e);(curr[0]!==this.curr[0]||curr[1]!==this.curr[1])&&(this.dirty=!0,this.curr=[curr[0],curr[1]])},endDrag:function(){this.origin=[],this.curr=[],this.grabCursor(),$document.off(this.moveEvent,this.updateBind),$document.off(this.upEvent,this.endBind),this.$el.off("mouseout",this.mouseOutBind),window.cancelAnimationFrame(this.loop)},positionFromEvent:function(e){return[e.pageX,e.pageY]},makeInteractive:function(){this.draggable.on(this.downEvent,this.startBind),this.touch||this.draggable.on(this.overEvent,this.mouseOverBind),this.$el.on("$destroy",this.destroy)},mouseOver:function(){this.grabCursor()},mouseOut:function(e){var el=e.target,isParent=el.querySelector&&el.querySelector(".panhandler-wrap");(isParent||void 0===e.toElement||"HTML"===e.toElement.tagName)&&this.endDrag()},destroy:function(){this.loop&&window.cancelAnimationFrame(this.loop),$document.off(this.upEvent,this.endBind)},grabCursor:function(){var isWk=navigator.userAgent.match(/WebKit/),isFF=navigator.userAgent.match(/Gecko/),cursor="move";this.isPrevented()?cursor="":isWk?cursor="-webkit-grab":isFF&&(cursor="-moz-grab"),this.draggable.css("cursor",cursor)},grabbingCursor:function(){var isWk=navigator.userAgent.match(/WebKit/),isFF=navigator.userAgent.match(/Gecko/);isWk?this.draggable.css("cursor","-webkit-grabbing"):isFF?this.draggable.css("cursor","-moz-grabbing"):this.draggable.css("cursor","move")}},{scope:{preventPan:"@preventPan"},link:function(scope,element,attr){setTimeout(function(){new Panhandler(element,attr,scope)})}}});var vendorize=function(){var vendors=["-webkit-","-moz-","-ms-",""];return function(prop,val){var out={};return angular.forEach(vendors,function(v){out[v+prop]=val}),out}}();!function(){for(var lastTime=0,vendors=["webkit","moz"],x=0;x<vendors.length&&!window.requestAnimationFrame;++x)window.requestAnimationFrame=window[vendors[x]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[vendors[x]+"CancelAnimationFrame"]||window[vendors[x]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(callback){var currTime=(new Date).getTime(),timeToCall=Math.max(0,16-(currTime-lastTime)),id=window.setTimeout(function(){callback(currTime+timeToCall)},timeToCall);return lastTime=currTime+timeToCall,id}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(id){clearTimeout(id)})}()}();